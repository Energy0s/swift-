# Análise cirúrgica — MT199 REF1771294346955

## 1. Estado atual da mensagem (mt_free.json)

```json
{
  "id": 1,
  "userId": 1,
  "mtType": "MT199",
  "messageId": "MT199-1771294399490-joucy5",
  "messageStatus": "Validated",
  "transactionReferenceNumber": "REF1771294346955",
  "relatedReference": "UETR-550e8400-e29b-41d4-a716-446655",
  "narrativeFreeText": "REFERENCE TO REQUESTED DOCUMENT...",
  "senderToReceiverInfo": "/DOC/ATTACHED DOCUMENT CDPO-118872 PROVIDED",
  "swiftHeader": {
    "messagePriority": "U",
    "senderBic": "BOMGBRS1XXX",
    "receiverBic": "CITISGSGXXX"
  }
}
```

**Audit log:** CREATED → MODIFIED (messageStatus) → SUBMITTED_FOR_APPROVAL (2x)

---

## 2. Fluxo esperado MT199

```
Draft → Validated → Pending Approval → Approved → Released to SWIFT → ACK/NACK → Completed
  │          │              │              │
  │          │              │              └─ 4-eyes: approvedBy1 + approvedBy2
  │          │              └─ submit-approval
  │          └─ validate
  └─ create (POST /messages)
```

---

## 3. Bug identificado

O `mtFreeStore.update()` só permite alterações quando `messageStatus === 'Draft'` ou `repairRequiredFlag === true`:

```typescript
// mtFreeStore.ts:148-149
const allowedStatuses = ['Draft'];
if (!allowedStatuses.includes(msg.messageStatus) && !msg.repairRequiredFlag) return null;
```

**Consequência:**
- **Validated → Pending Approval** (submit-approval): `update()` retorna `null` → status não muda
- **Pending Approval → Approved** (approve): `update()` retorna `null` → status não muda

O audit log registrava `SUBMITTED_FOR_APPROVAL` duas vezes porque a rota chamava `addAuditEntry` mesmo quando `update()` falhava, mas o status permanecia em `Validated`.

---

## 4. Correção aplicada

As rotas `submit-approval` e `approve` passaram a usar `updateForWorkflow()` em vez de `update()`:

| Ação            | Antes                    | Depois                                                       |
|-----------------|--------------------------|--------------------------------------------------------------|
| submit-approval | `update()` (falhava)     | `updateForWorkflow(id, data, ['Draft','Validated'], userId)` |
| approve         | `update()` (falhava)     | `updateForWorkflow(id, data, ['Pending Approval'], userId)`  |

---

## 5. Arquitetura do fluxo MT199

### Backend
- **Rota base:** `POST/GET /api/swift/free/messages`
- **Store:** `mtFreeStore` → `data/mt_free.json`
- **Serviço:** `mtFreeModuleService` (validação, geração FIN, 4-eyes)

### Frontend
- **Lista:** `/free` → `MtFreeListPage`
- **Detalhe:** `/free/:id` → `MtFreeDetailPage`
- **Formulário:** `/free/new`, `/free/:id/edit` → `MtFreeFormPage`
- **API:** `mtFreeService` → base `/swift/free`

### Rotas de workflow
| Método | Endpoint                    | Status de → para              |
|--------|-----------------------------|-------------------------------|
| POST   | `/messages/:id/validate`    | Draft → Validated             |
| POST   | `/messages/:id/submit-approval` | Draft/Validated → Pending Approval |
| POST   | `/messages/:id/approve`     | Pending Approval → Approved  |
| POST   | `/messages/:id/release`     | Approved → Released to SWIFT |
| POST   | `/messages/:id/ack`        | → ACK Received               |
| POST   | `/messages/:id/nack`        | → NACK Received               |
| POST   | `/messages/:id/cancel`     | → Cancelled                  |

---

## 6. Próximos passos para REF1771294346955

Com a correção, a mensagem em `Validated` pode ser submetida:

1. Acesse `/free/1` (detalhe da mensagem)
2. Clique em **Submeter** → status vai para `Pending Approval`
3. Clique em **Submeter** novamente (1ª aprovação) → `approvedBy1` definido
4. Clique em **Submeter** novamente (2ª aprovação, mesmo usuário) → status vai para `Approved`
5. Clique em **Liberar** → status vai para `Released to SWIFT`
